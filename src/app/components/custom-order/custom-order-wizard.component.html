<div class="custom-order-container">
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-steps">
            <div *ngFor="let step of steps; let i = index" [class.active]="currentStep >= i"
                [class.completed]="currentStep > i" [class.valid]="i < currentStep && formValid" class="step">
                <div class="step-number">
                    <i *ngIf="i < currentStep && formValid" class="fas fa-check"></i>
                    <span *ngIf="!(i < currentStep && formValid)">{{ i + 1 }}</span>
                </div>
                <div class="step-label">{{ step }}</div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-area">
        <!-- Preview Section -->
        <div class="preview-section">
            <div class="preview-container" [class.loading]="previewLoading">
                <div class="preview-image">
                    <img [src]="currentPreviewImage" [alt]="candleForm.get('shape')?.value + ' candle preview'"
                        [@fadeAnimation]>
                    <div class="preview-overlay" *ngIf="previewLoading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="preview-controls">
                    <button (click)="togglePreviewFlame()" class="btn-preview">
                        <i class="fas" [class.fa-fire]="!showPreviewFlame" [class.fa-fire-alt]="showPreviewFlame"></i>
                        {{ showPreviewFlame ? 'Extinguish' : 'Light' }} Candle
                    </button>
                    <div class="preview-price">
                        Estimated Price: ${{ calculatePrice() }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <form [formGroup]="candleForm" (ngSubmit)="onSubmit()">
                <!-- Step 1: Shape & Size -->
                <div *ngIf="currentStep === 0" class="step-content" @slideAnimation>
                    <h3>Choose Your Candle Shape</h3>
                    <div class="shape-options">
                        <div *ngFor="let shape of shapes" class="shape-option"
                            [class.selected]="isOptionSelected(shape.value, 'shape')"
                            (click)="candleForm.patchValue({ shape: shape.value })">
                            <i [class]="shape.icon"></i>
                            <span>{{ shape.label }}</span>
                        </div>
                    </div>

                    <h3>Select Size</h3>
                    <div class="size-options">
                        <div *ngFor="let size of sizes" class="size-option"
                            [class.selected]="isOptionSelected(size.value, 'size')"
                            (click)="candleForm.patchValue({ size: size.value })">
                            <i [class]="size.icon"></i>
                            <div class="size-details">
                                <span class="size-label">{{ size.label }}</span>
                                <span class="size-volume">{{ size.volume }}</span>
                                <span class="size-price">${{ size.price }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Color & Container -->
                <div *ngIf="currentStep === 1" class="step-content" @slideAnimation>
                    <h3>Choose Your Color</h3>
                    <div class="color-picker">
                        <div *ngFor="let color of colors" class="color-swatch" [style.background-color]="color.value"
                            [class.selected]="isOptionSelected(color.value, 'color')"
                            (click)="candleForm.patchValue({ color: color.value })">
                            <i class="fas fa-check" *ngIf="isOptionSelected(color.value, 'color')"></i>
                            <span class="color-label">{{ color.label }}</span>
                        </div>
                    </div>

                    <h3>Select Container Style</h3>
                    <div class="container-options">
                        <div *ngFor="let container of containers" class="container-option"
                            [class.selected]="isOptionSelected(container.value, 'container')"
                            (click)="candleForm.patchValue({ container: container.value })">
                            <img [src]="container.image" [alt]="container.label">
                            <div class="container-details">
                                <span class="container-label">{{ container.label }}</span>
                                <span class="container-price" *ngIf="container.price > 0">+${{ container.price }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Scent Selection -->
                <div *ngIf="currentStep === 2" class="step-content" @slideAnimation>
                    <h3>Create Your Scent Profile</h3>
                    <div class="scent-selection">
                        <div class="primary-scent">
                            <h4>Primary Scent</h4>
                            <div class="scent-options">
                                <div *ngFor="let scent of scents" class="scent-option"
                                    [class.selected]="isOptionSelected(scent.value, 'scentPrimary')"
                                    (click)="candleForm.patchValue({ scentPrimary: scent.value })">
                                    <i [class]="scent.icon"></i>
                                    <span>{{ scent.label }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="scent-intensity">
                            <h4>Scent Intensity</h4>
                            <div class="intensity-slider">
                                <input type="range" min="1" max="5" formControlName="scentIntensity"
                                    class="custom-range">
                                <div class="intensity-labels">
                                    <span>Subtle</span>
                                    <span>Balanced</span>
                                    <span>Strong</span>
                                </div>
                                <div class="intensity-value">
                                    Level: {{ candleForm.get('scentIntensity')?.value }}/5
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Personalization -->
                <div *ngIf="currentStep === 3" class="step-content" @slideAnimation>
                    <h3>Add Your Personal Touch</h3>
                    <div class="personalization-options">
                        <div class="message-input">
                            <label>Custom Message or Label</label>
                            <input type="text" formControlName="message" placeholder="Enter your message (optional)"
                                maxlength="50">
                            <div class="input-feedback">
                                <small>{{ 50 - (candleForm.get('message')?.value?.length || 0) }} characters
                                    remaining</small>
                            </div>
                        </div>

                        <div class="label-style" *ngIf="candleForm.get('message')?.value">
                            <label>Label Style</label>
                            <div class="label-options">
                                <div *ngFor="let style of labelStyles" class="label-style-option"
                                    [class.selected]="isOptionSelected(style.value, 'label')"
                                    (click)="candleForm.patchValue({ label: style.value })">
                                    <i [class]="style.icon"></i>
                                    <span>{{ style.label }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="step-navigation">
                    <button type="button" class="btn-secondary" (click)="previousStep()" *ngIf="currentStep > 0">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button type="button" class="btn-primary" (click)="nextStep()" [disabled]="!formValid"
                        *ngIf="currentStep < steps.length - 1">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" class="btn-success" *ngIf="currentStep === steps.length - 1"
                        [disabled]="!candleForm.valid">
                        Add to Cart <i class="fas fa-shopping-cart"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>